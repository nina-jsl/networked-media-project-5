"use strict";var _regeneratorRuntime=_interopRequireDefault(require("regenerator-runtime"));var _nedbPromises=_interopRequireDefault(require("nedb-promises"));var _events=require("events");function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{Promise.resolve(value).then(_next,_throw)}}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise(function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(undefined)})}}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==="function"){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable}))}ownKeys.forEach(function(key){_defineProperty(target,key,source[key])})}return target}var _this=void 0;var ONE_DAY=8640e4;var TWO_WEEKS=14*ONE_DAY;var makeStore=function(options){var _defaultExpiry;var defaultExpiry=(_defaultExpiry=options.defaultExpiry)!==null&&_defaultExpiry!==void 0?_defaultExpiry:TWO_WEEKS;var datastore=_nedbPromises.default.create(_objectSpread({},options,{autoload:true,timestampData:true,onload:function(error){if(error){store.emit('error',error)}store.emit("".concat(error?'dis':'',"connect"));if(options.onload)options.onload(error)}},options.inMemoryOnly?{afterSerialization:undefined,beforeDeserialization:undefined,corruptAlertThreshold:undefined}:{}));if(options.filename&&options.autoCompactInterval){var autoCompactInterval=Math.min(Math.max(options.autoCompactInterval,5000),ONE_DAY);datastore.persistence.setAutocompactionInterval(autoCompactInterval)}var _Store;var parentStore=((_Store=options.connect.Store)!==null&&_Store!==void 0?_Store:options.connect.session.Store).prototype;var store=_objectSpread({},_events.EventEmitter.prototype,parentStore,{set:_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(sid,session,callback){var ref,expirationDate,sess;return _regeneratorRuntime.default.wrap(function _callee$(_ctx){while(1)switch(_ctx.prev=_ctx.next){case 0:;expirationDate=(session===null||session===void 0?void 0:(ref=session.cookie)===null||ref===void 0?void 0:ref.expires)?new Date(session.cookie.expires):new Date(Date.now()+defaultExpiry);sess=_objectSpread({},session);_ctx.prev=3;_ctx.next=6;return datastore.update({_id:sid},{$set:{session:sess,expiresAt:expirationDate}},{multi:false,upsert:true});case 6:if(callback)callback();_ctx.next=12;break;case 9:_ctx.prev=9;_ctx.t0=_ctx["catch"](3);if(callback)callback(_ctx.t0);case 12:case"end":return _ctx.stop()}},_callee,null,[[3,9]])})),touch:_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(sid,session,callback){var ref,touchSetOp;return _regeneratorRuntime.default.wrap(function _callee$(_ctx){while(1)switch(_ctx.prev=_ctx.next){case 0:;touchSetOp=_objectSpread({updatedAt:new Date()},(session===null||session===void 0?void 0:(ref=session.cookie)===null||ref===void 0?void 0:ref.expires)?{expiresAt:new Date(session.cookie.expires)}:{});_ctx.next=4;return datastore.update({_id:sid},{$set:touchSetOp},{multi:false,upsert:false});case 4:if(callback)callback();case 5:case"end":return _ctx.stop()}},_callee)})),get:_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(sid,callback){var doc;return _regeneratorRuntime.default.wrap(function _callee$(_ctx){while(1)switch(_ctx.prev=_ctx.next){case 0:_ctx.prev=0;_ctx.next=3;return datastore.findOne({_id:sid});case 3:doc=_ctx.sent;if(!(doc!=null)){_ctx.next=8;break}if(!(doc.session&&!doc.expiresAt||new Date()<doc.expiresAt)){_ctx.next=7;break}return _ctx.abrupt("return",callback(null,doc.session));case 7:return _ctx.abrupt("return",store.destroy(sid,function(error){callback(error,null)}));case 8:callback(null);_ctx.next=14;break;case 11:_ctx.prev=11;_ctx.t0=_ctx["catch"](0);callback(_ctx.t0,null);case 14:case"end":return _ctx.stop()}},_callee,null,[[0,11]])})),all:_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(callback){var existingDocs,sessions;return _regeneratorRuntime.default.wrap(function _callee$(_ctx){while(1)switch(_ctx.prev=_ctx.next){case 0:_ctx.prev=0;_ctx.next=3;return datastore.find({});case 3:existingDocs=_ctx.sent;sessions=existingDocs.reduce(function(accumulator,doc){if(doc.session&&!doc.expiresAt||new Date()<doc.expiresAt){accumulator.push(doc.session)}store.destroy(doc._id,function(error){return error&&store.emit('error',error)});return accumulator},[]);callback(null,sessions);_ctx.next=11;break;case 8:_ctx.prev=8;_ctx.t0=_ctx["catch"](0);callback(_ctx.t0,null);case 11:case"end":return _ctx.stop()}},_callee,null,[[0,8]])})),length:_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(callback){return _regeneratorRuntime.default.wrap(function _callee$(_ctx){while(1)switch(_ctx.prev=_ctx.next){case 0:if(store.all!=null){store.all(function(err,sessions){callback(err,sessions.length)})}case 1:case"end":return _ctx.stop()}},_callee)})),destroy:_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(sid,callback){return _regeneratorRuntime.default.wrap(function _callee$(_ctx){while(1)switch(_ctx.prev=_ctx.next){case 0:_ctx.prev=0;_ctx.next=3;return datastore.remove({_id:sid},{multi:false});case 3:if(callback)callback();_ctx.next=9;break;case 6:_ctx.prev=6;_ctx.t0=_ctx["catch"](0);if(callback)callback(_ctx.t0);case 9:case"end":return _ctx.stop()}},_callee,null,[[0,6]])})),clear:_asyncToGenerator(_regeneratorRuntime.default.mark(function _callee(callback){return _regeneratorRuntime.default.wrap(function _callee$(_ctx){while(1)switch(_ctx.prev=_ctx.next){case 0:_ctx.prev=0;_ctx.next=3;return datastore.remove({},{multi:this});case 3:if(callback)callback();_ctx.next=9;break;case 6:_ctx.prev=6;_ctx.t0=_ctx["catch"](0);if(callback)callback(_ctx.t0);case 9:case"end":return _ctx.stop()}},_callee,this,[[0,6]])}).bind(_this)).bind(_this)});return store};module.exports=makeStore
